<!doctype html>
<html>
<head>
    <title>Bullet Dodge</title>
</head>
<body>
  <h1>Bullet Dodge</h1>
  <canvas id="game"></canvas>
  <br>
  <button onClick="start()">Start / Restart Game</button>
  <p>Use the arrow keys to move about, use "x" to activate your shield</p>
  <p>You are the adventurer Reginold Staterly taking his newly invented jetpack for a spin when your arch rival Baron Spartly attempts to shoot you from the sky in his dirigable <em>The Flying Marshmellow</em>. </p><p>Have fun</p>
</body>
<script type="text/javascript">
   var canvas = document.getElementById("game");
   canvas.innerHTML = "I guess canvs is not supported soooooooooooooooo I guess no game for you!"
   var ctx = canvas.getContext("2d");

   canvas.width = 500;

   canvas.height = 500;


   bgLoaded = false
   bg = new Image()

   bg.onload = function(){
    bgLoaded = true
   }

   bg.src = "img/bg.png"

   chara = new Image()
   charaLoaded = false
   chara.onload = function(){
    charaLoaded = true
   }
   chara.src = "img/char.png"

   bulletimg = new Image()
   bulletLoaded = false
   bulletimg.onload = function(){
    bulletLoaded = true
   }
   bulletimg.src = "img/bullet.png"
   sheildLoaded = false
   sheildimg = new Image()
   sheildimg.src = "img/shield.png"
    sheildimg.onload = function(){
    sheildLoaded = true
   }
   charflameLoaded = false
   charflame = new Image()
   charflame.src = "img/charflame.png"
    charflame.onload = function(){
    charflameLoaded = true
   }
   charadeadLoaded = false
   charadead = new Image()
   charadead.src = "img/dead.png"
    charadead.onload = function(){
    charadeadLoaded = true
   }
   splashLoaded = false
   splash = new Image()
   splash.src = "img/splash.png"
    splash.onload = function(){
    splashLoaded = true
   }
   

   var keysDown = {};

   addEventListener("keydown", function (e) {
    keysDown[e.keyCode] = true;
   }, false);

   addEventListener("keyup", function (e) {
    delete keysDown[e.keyCode];
   }, false);

   hero = {
    x:20,
    y:canvas.height/2,
    speed: 200,
    sheild:false
   }
   bullets = []
   render = function(){
    if (bgLoaded) {
         ctx.drawImage(bg, 0,0);
     }

    if (charaLoaded) {
      if(!hero.dead){
        if(hero.flame){
          ctx.drawImage(charflame, hero.x, hero.y);
        }
        else{
          ctx.drawImage(chara, hero.x, hero.y);
        }
      }
      else{
        ctx.drawImage(charadead, hero.x, hero.y);
      }
       
         
     }
     if(bulletLoaded){
      renderbullets()
     }
     //score
      ctx.fillStyle = "rgb(250, 250, 250)";
      ctx.font = "24px Helvetica";
      ctx.textAlign = "right";
      ctx.textBaseline = "bottom";
      ctx.fillText("Score: "+score,canvas.width-20,  canvas.height-20);
      //sheilds
      ctx.fillStyle = "rgb(250, 250, 250)";
      ctx.font = "24px Helvetica";
      ctx.textAlign = "left";
      ctx.textBaseline = "bottom";
      ctx.fillText("Shields: "+sheilds,canvas.width/2, canvas.height-20);
      //shield time
      if(hero.sheild){
        ctx.drawImage(sheildimg, hero.x+chara.width, hero.y)
        ctx.fillStyle = "rgb(250, 0, 0)";
        ctx.fillRect(hero.x+10, hero.y-5,30,5);
        ctx.fillStyle = "rgb(0, 250, 0)";
        ctx.fillRect(hero.x+10, hero.y-5,30*(hero.sheildtimeleft/10),5);
      }
      
   }
   renderbullets = function(){
      for(i in bullets){
        bullet = bullets[i]
        ctx.drawImage(bulletimg, bullet.x, bullet.y);
      }
   }
   randomInt= function(min,max){
    return Math.round(Math.random() * (max - min) + min)
   }
   updatebullets = function(modifier,survived,once){
    bulletcount = bullets.length
    
    if(bulletcount === 0 ){
        bullets.push({"x":500,"y":hero.y,"speed":250}) 
      }
    if(survived % 10 === 0){
      if(!once[survived]){
        bullets.push({"x":randomInt(500,550),"y":hero.y,"speed":randomInt(200,300)})
        once[survived] = true
      }
      
    }
    for(i in bullets){
      bullet = bullets[i]
      if(bulletcount > 0){
        if(bullet.x <= 0){
        bullet.x = 500
        bullet.y = randomInt(hero.y-75,hero.y+75)
        
        }
        else{
          bullet.x -= bullet.speed * modifier
        }
      }
      
      
      if(
        hero.x <= (bullet.x + bulletimg.width)
        && bullet.x <= (hero.x + chara.width)
        && hero.y <= (bullet.y + bulletimg.height)
        && bullet.y <= (hero.y + chara.height)
    )
      {
        if(hero.sheild){
          bullets.splice(i,1)
        }
        else{
          renderDeath(function(){
            gamestate.running = false
            gamestate.gameEnd = true
          })
          
          
        }
      }
    }
   }
   restart = function(){
    hero.x = 20
    hero.y = (canvas.height -20)-chara.height
    bullets = []
    survived = 1
    once = []
    score = 0
    gamestate.countdown = true
    sheilds = 3
    then = Date.now()
    hero.dead = false
   }
    
   
   update = function(modifier,survived,once){
    
    maxy = 480
    maxx = 480
    miny = 20
    minx = 20
    if(!hero.dead){
      if (38 in keysDown) { // Player holding up
        (hero.y <= miny) ? miny : hero.y -= hero.speed * modifier
        hero.flame = true
      }
      else{
        (hero.y >= maxy- chara.height) ? maxy : hero.y += (hero.speed/4) * modifier
        hero.flame = false
      }
      if (40 in keysDown) { // Player holding down
        (hero.y >= maxy - chara.height) ? maxy : hero.y += hero.speed * modifier
      }
      if (37 in keysDown) { // Player holding left
        (hero.x <= minx) ? minx : hero.x -= hero.speed * modifier
      }
      if (39 in keysDown) { // Player holding right
        (hero.x >= maxx - chara.height) ? maxx : hero.x += hero.speed * modifier
      }
      if(88 in keysDown){
        activateSheild(survived)
      }
      deactivateSheild(survived)
      updatebullets(modifier,survived,once)
    }
      
   }
  activateSheild = function(survived){
    if(!hero.sheild ){
      if(sheilds >0 ){
        sheilds -= 1
        hero.sheild = true
        hero.sheildstart = survived
        hero.sheildtimeleft = 10
      }
    }
    
  }
  deactivateSheild = function(survived){
    if(hero.sheild){
      if(survived - hero.sheildstart >= 10){
        hero.sheild = false
      }
      else{
        hero.sheildtimeleft = 10 - ( survived - hero.sheildstart)
      }
    }
    
  }
  countdown = function(then,now){
    //gamestate.countdown = false
    
    seconds = parseInt((now-then)/1000,10)
    if(seconds <= 3){
      time = (seconds - 3) * -1
      ctx.clearRect(0,0,canvas.width,canvas.height)
      ctx.fillStyle = "rgb(0, 0, 0)";
      ctx.font = "50px Helvetica";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      if(time === 0){
        ctx.fillText("Go!",canvas.width/2, canvas.height/2);        
      }
      else{
        ctx.fillText(time,canvas.width/2, canvas.height/2);
      }
      
    }
    else{
      restart()
      gamestate.countdown = false

    }
  }
  renderDeath = function(callback){
    hero.dead = true
    setTimeout(callback,1500)
  }
  gamestate = {
    running : false,
    gameEnd : false,
    countdown : false,
  }
   main = function(){
      if(gamestate.running){
          if(gamestate.countdown){
            countdown(then,Date.now())
          }
          else{
            now = Date.now()
            delta = now - then
            update(delta/1000,parseInt(survived),once)
            render()
            then = now
            survived += delta/1000
            score = Math.ceil(survived)
          } 
      }
      else{
        if(gamestate.gameEnd){
          ctx.clearRect(0,0,500,500)
          ctx.fillStyle = "rgb(0, 0, 0)";
          ctx.font = "24px Helvetica";
          ctx.textAlign = "left";
          ctx.textBaseline = "top";
          ctx.fillText("Too bad you lost Your final score was: "+score,30,30);
        }
        else{
          if(splashLoaded){
            ctx.drawImage(splash,0,0,500,500)
          }
          
        }
        
      }
      
    //console.log(score)
   }
   start = function(){
    restart()
    gamestate.running = true
    
   }
   then = Date.now()
   sheilds = 3
   survived = 1
   once = []
   
   score = 0
   var refreshId = setInterval(main,1)
   

</script>
</html>