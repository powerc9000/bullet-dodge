<!doctype html>
<html>
<head>
    <title>8-bit fighiting of death</title>
</head>
<body>
</body>
<script type="text/javascript">
   var canvas = document.createElement("canvas");
   canvas.innerHTML = "I guess canvs is not supported soooooooooooooooo I guess no game for you!"
   var ctx = canvas.getContext("2d");

   canvas.width = 500;

   canvas.height = 500;

   document.body.appendChild(canvas);

   bgLoaded = false
   bg = new Image()

   bg.onload = function(){
    bgLoaded = true
   }

   bg.src = "img/bg.png"

   chara = new Image()
   charaLoaded = false
   chara.onload = function(){
    charaLoaded = true
   }
   chara.src = "img/char.png"

   bulletimg = new Image()
   bulletLoaded = false
   bulletimg.onload = function(){
    bulletLoaded = true
   }
   bulletimg.src = "img/bullet.png"
   sheildLoaded = false
   sheildimg = new Image()
   sheildimg.src = "img/shield.png"
    sheildimg.onload = function(){
    sheildLoaded = true
   }
   charflameLoaded = false
   charflame = new Image()
   charflame.src = "img/charflame.png"
    charflame.onload = function(){
    charflameLoaded = true
   }
   

   var keysDown = {};

   addEventListener("keydown", function (e) {
    keysDown[e.keyCode] = true;
   }, false);

   addEventListener("keyup", function (e) {
    delete keysDown[e.keyCode];
   }, false);

   hero = {
    x:20,
    y:canvas.height/2,
    speed: 200,
    sheild:false
   }
   bullets = []
   render = function(){
    if (bgLoaded) {
         ctx.drawImage(bg, 0,0);
     }

    if (charaLoaded) {
        if(hero.flame){
          ctx.drawImage(charflame, hero.x, hero.y);
        }
        else{
          ctx.drawImage(chara, hero.x, hero.y);
        }
         
     }
     if(bulletLoaded){
      renderbullets()
     }
     //score
      ctx.fillStyle = "rgb(250, 250, 250)";
      ctx.font = "24px Helvetica";
      ctx.textAlign = "right";
      ctx.textBaseline = "bottom";
      ctx.fillText("Score: "+score,canvas.width-20,  canvas.height-20);
      //sheilds
      ctx.fillStyle = "rgb(250, 250, 250)";
      ctx.font = "24px Helvetica";
      ctx.textAlign = "left";
      ctx.textBaseline = "bottom";
      ctx.fillText("Shields: "+sheilds,canvas.width/2, canvas.height-20);
      //shield time
      if(hero.sheild){
        ctx.drawImage(sheildimg, hero.x+chara.width, hero.y)
        ctx.fillStyle = "rgb(250, 0, 0)";
        ctx.fillRect(hero.x+10, hero.y-5,30,5);
        ctx.fillStyle = "rgb(0, 250, 0)";
        ctx.fillRect(hero.x+10, hero.y-5,30*(hero.sheildtimeleft/10),5);
      }
      
   }
   renderbullets = function(){
      for(i in bullets){
        bullet = bullets[i]
        ctx.drawImage(bulletimg, bullet.x, bullet.y);
      }
   }
   randomInt= function(min,max){
    return Math.round(Math.random() * (max - min) + min)
   }
   updatebullets = function(modifier,survived,once){
    bulletcount = bullets.length
    console.log(bullets)
    if(bulletcount === 0 ){
        bullets.push({"x":500,"y":hero.y,"speed":250}) 
      }
    if(survived % 10 === 0){
      if(!once[survived]){
        bullets.push({"x":randomInt(500,550),"y":hero.y,"speed":randomInt(200,300)})
        once[survived] = true
      }
      
    }
    for(i in bullets){
      bullet = bullets[i]
      if(bulletcount > 0){
        if(bullet.x <= 0){
        bullet.x = 500
        bullet.y = randomInt(hero.y,hero.y+50)
        
        }
        else{
          bullet.x -= bullet.speed * modifier
        }
      }
      
      
      if(
        hero.x <= (bullet.x + bulletimg.width)
        && bullet.x <= (hero.x + chara.width)
        && hero.y <= (bullet.y + bulletimg.height)
        && bullet.y <= (hero.y + chara.height)
    )
      {
        if(hero.sheild){
          bullets.splice(i,1)
        }
        else{

          gamestate.running = false
          
        }
      }
    }
   }
   restart = function(){
    hero.x = 20
    hero.y = canvas.width/2
    bullets = []
    survived = 1
    once = []
    score = 0
    
    sheilds = 3
   }
    
   
   update = function(modifier,survived,once){
    
    maxy = 480
    maxx = 480
    miny = 20
    minx = 20
      if (38 in keysDown) { // Player holding up
        (hero.y <= miny) ? miny : hero.y -= hero.speed * modifier
        hero.flame = true
      }
      else{
        (hero.y >= maxy- chara.height) ? maxy : hero.y += (hero.speed/4) * modifier
        hero.flame = false
      }
      if (40 in keysDown) { // Player holding down
        (hero.y >= maxy - chara.height) ? maxy : hero.y += hero.speed * modifier
      }
      if (37 in keysDown) { // Player holding left
        (hero.x <= minx) ? minx : hero.x -= hero.speed * modifier
      }
      if (39 in keysDown) { // Player holding right
        (hero.x >= maxx - chara.height) ? maxx : hero.x += hero.speed * modifier
      }
      if(88 in keysDown){
        activateSheild(survived)
      }
      deactivateSheild(survived)
      updatebullets(modifier,survived,once)
   }
  activateSheild = function(survived){
    if(!hero.sheild ){
      if(sheilds >0 ){
        sheilds -= 1
        hero.sheild = true
        hero.sheildstart = survived
        hero.sheildtimeleft = 10
      }
    }
    
  }
  deactivateSheild = function(survived){
    if(hero.sheild){
      if(survived - hero.sheildstart >= 10){
        hero.sheild = false
      }
      else{
        hero.sheildtimeleft = 10 - ( survived - hero.sheildstart)
      }
    }
    
  }
  gamestate = {
    running : true
  }
   main = function(){
      if(gamestate.running){
        now = Date.now()
        delta = now - then
        update(delta/1000,parseInt(survived),once)
        render()
        then = now
        survived += delta/1000
        score = Math.ceil(survived)
      }
      else{
        ctx.clearRect(0,0,500,500)
        ctx.fillStyle = "rgb(0, 0, 0)";
        ctx.font = "24px Helvetica";
        ctx.textAlign = "left";
        ctx.textBaseline = "top";
        ctx.fillText("Too bad you lost \n Your final score was: "+score,30,30);
      }
      
    //console.log(score)
   }

   then = Date.now()
   sheilds = 3
   survived = 1
   once = []
   
   score = 0
   var refreshId = setInterval(main,1)
   

</script>
</html>